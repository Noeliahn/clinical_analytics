version: 2

models:

  - name: dim_date
    description: "Dimensión de fechas generada con la macro dbt_date"
  # =========================================================================
  # Gold - Conditions
  # =========================================================================
  - name: dim_condition
    description: "Tabla gold de condiciones por estudio clínico."
    columns:
      - name: id_condition
        description: "Identificador único de la condición."
        tests:
          - not_null
          - unique
      - name: nct_id
        description: "ID del estudio clínico normalizado."
        tests:
          - not_null

      - name: condition_name
        description: "Nombre de la condición asociada al estudio."
      - name: disease_id
        description: "FK a dim_disease."
        tests:
          - relationships:
              arguments:
                to: ref('dim_disease')
                field: disease_id
  - name: dim_event
    description: "Tabla gold de eventos reportados, combinando staging de AACT y dimensiones normalizadas."
    columns:
      - name: organ_system_id
        description: "FK al sistema de órganos (normalizado en gold)."
        tests:
          - not_null
      - name: organ_system
        description: "Nombre del sistema de órganos."
      - name: adverse_event_term_id
        description: "FK al término de evento adverso (normalizado en gold)."
        tests:
          - not_null
      - name: adverse_event_term
        description: "Nombre del término de evento adverso."
      - name: ctgov_group_code_id
        description: "FK al código de grupo CTGOV (normalizado en gold)."
        tests:
          - not_null
      - name: ctgov_group_code
        description: "Código de grupo CTGOV."
      - name: nct_id
        description: "ID del estudio clínico."
      - name: event_type_id
        description: "ID del tipo de evento (normalizado en gold)."
      - name: event_type
        description: "Tipo de evento."
      - name: classification_id
        description: "ID de la clasificación del evento (normalizada en gold)."
      - name: classification
        description: "Clasificación del evento."


  # =========================================================================
  # Gold - Facilities
  # =========================================================================
  - name: dim_facility
    description: "Tabla gold de instalaciones asociadas a estudios clínicos."
    columns:
      - name: id_facilities
        description: "Identificador único de la instalación."
        tests:
          - not_null
          - unique
      - name: nct_id
        description: "ID del estudio clínico."
        tests:
          - not_null
      - name: status_id
        description: "FK al estado de la instalación (valor normalizado en gold)."
      - name: country_id
        description: "FK al país de la instalación (valor normalizado en gold)."
      - name: latitude
        description: "Latitud de la instalación."
      - name: longitude
        description: "Longitud de la instalación."


  # =========================================================================
  # Gold - Interventions
  # =========================================================================
  - name: dim_intervention
    description: "Tabla gold de intervenciones asociadas a estudios clínicos."
    columns:
      - name: id_interventions
        description: "Identificador único de la intervención."
        tests:
          - not_null
          - unique
      - name: nct_id
        description: "ID del estudio clínico."
        tests:
          - not_null
      - name: intervention_type_id
        description: "FK al tipo de intervención (normalizado en gold)."
      - name: intervention_name
        description: "Nombre de la intervención."
      - name: description
        description: "Descripción de la intervención."


  # =========================================================================
  # Gold - Patient Dimension
  # =========================================================================
  - name: dim_patient
    description: "Dimensión de pacientes proveniente de SEER."
    columns:
      - name: patient_id
        description: "Identificador único del paciente."
      - name: gender_id
        description: "FK al género del paciente (normalizado en gold)."
      - name: primary_site_id
        description: "FK al sitio primario de la enfermedad."
      - name: vital_status_id
        description: "FK al estado vital del paciente."
      - name: cause_of_death_id
        description: "FK a la causa de muerte si aplica."
      - name: age_recode
        description: "Edad categorizada del paciente."
      - name: year_of_diagnosis
        description: "Año de diagnóstico."
      - name: survival_months
        description: "Meses de supervivencia desde el diagnóstico."
      - name: disease_id
        description: "FK a dim_disease derivado del primary_site."
      - name: ingestion_date
        description: "Fecha de carga de los datos."


  # =========================================================================
  # Gold - Sponsors
  # =========================================================================
  - name: dim_sponsor
    description: "Tabla gold de patrocinadores de los estudios."
    columns:
      - name: sponsor_row_id
        description: "ID de la fila del patrocinador."
        tests:
          - not_null
          - unique
      - name: nct_id
        description: "ID del estudio clínico."
        tests:
          - not_null
      - name: agency_class_id
        description: "FK a la clase de agencia (normalizada en gold)."
      - name: agency_class
        description: "Nombre de la clase de agencia."
      - name: lead_or_collaborator_id
        description: "FK al lead o colaborador (normalizado en gold)."
      - name: lead_or_collaborator
        description: "Nombre del lead o colaborador."
      - name: sponsor_name
        description: "Nombre del patrocinador."


  # =========================================================================
  # Gold - Study Counts
  # =========================================================================
  - name: dim_study
    description: "Tabla gold con conteos de condiciones, instalaciones e intervenciones por estudio."
    columns:
      - name: nct_id
        description: "ID del estudio clínico."
        tests:
          - not_null
          - unique
      - name: condition_count
        description: "Número de condiciones asociadas al estudio."
      - name: facility_count
        description: "Número de instalaciones asociadas al estudio."
      - name: intervention_count
        description: "Número de intervenciones asociadas al estudio."
      - name: ingestion_date
        description: "Fecha de carga de los datos."


  # =========================================================================
  # Gold - Reported Events (fact incremental)
  # =========================================================================
  - name: fct_adverse_events
    config:
      meta:
        always_create_constraint: true
    description: "Tabla incremental de eventos reportados por estudio clínico."
    columns:
      - name: id_reported_events
        description: "ID del evento reportado."
        tests:
          - not_null
          - unique
      - name: nct_id
        description: "ID del estudio clínico."
        tests:
          - not_null
      - name: organ_system_id
        description: "FK al sistema de órganos (apunta a dim_event.organ_system_id)."
        tests:
          - relationships:
              arguments:
                to: ref('dim_event')
                field: organ_system_id
      - name: adverse_event_term_id
        description: "FK al término de evento adverso (apunta a dim_event.adverse_event_term_id)."
        tests:
          - relationships:
              arguments:
                to: ref('dim_event')
                field: adverse_event_term_id
      - name: ctgov_group_code_id
        description: "FK al código de grupo CTGOV (apunta a dim_event.ctgov_group_code_id)."
        tests:
          - relationships:
              arguments:
                to: ref('dim_event')
                field: ctgov_group_code_id
      - name: subjects_affected
        description: "Número de sujetos afectados."
      - name: subjects_at_risk
        description: "Número de sujetos en riesgo."
      - name: event_count
        description: "Número total de eventos reportados."


  # =========================================================================
  # Gold - Drop Withdrawals (fact incremental)
  # =========================================================================
  - name: fct_dropout_withdrawals
    description: "Tabla incremental de retiros/drop-outs en los estudios."
    columns:
      - name: id_drop_withdrawals
        description: "ID único de retiro/drop."
        tests:
          - not_null
          - unique
      - name: nct_id
        description: "ID del estudio clínico."
        tests:
          - not_null
      - name: result_group_id
        description: "FK al grupo de resultados (se asocia aquí a dim_event.event_type_id por normalización gold)."
      - name: ctgov_group_code_id
        description: "FK al código de grupo CTGOV (apunta a dim_event.ctgov_group_code_id)."
      - name: period_id
        description: "FK al período de reporte (si lo normalizas en gold, referencia aquí)."
      - name: reason_id
        description: "FK a la razón del retiro (si lo normalizas en gold, referencia aquí)."
      - name: withdrawal_count
        description: "Número de retiros/reportados."


  # =========================================================================
  # Gold - Facility Enrollment Fact
  # =========================================================================
  - name: fct_facility_enrollment
    description: "Tabla de hechos de enrolamiento de pacientes por instalación."
    columns:
      - name: id_facilities
        description: "FK a la instalación."
        tests:
          - not_null
          - relationships:
              arguments:
                to: ref('dim_facility')
                field: id_facilities
      - name: nct_id
        description: "ID del estudio clínico."
        tests:
          - not_null
      - name: status_id
        description: "FK al estado de la instalación (valor almacenado en dim_facility.status_id)."
        tests:
          - relationships:
              arguments:
                to: ref('dim_facility')
                field: status_id
      - name: country_id
        description: "FK al país de la instalación (valor almacenado en dim_facility.country_id)."
        tests:
          - relationships:
              arguments:
                to: ref('dim_facility')
                field: country_id

  # =========================================================================
  # Gold - dim_disease
  # =========================================================================
  - name: dim_disease
    description: "Catálogo maestro de enfermedades unificado SEER + AACT."
    columns:
      - name: disease_id
        tests: [not_null, unique]

      - name: disease_name_normalized
        description: "Nombre estandarizado de enfermedad."

      - name: sources
        description: "Lista de fuentes que aportan esta enfermedad (seer, aact, both)."

