version: 2

models:

  # -------------------------------------------------------------------------
  # base_aact_design_group
  # -------------------------------------------------------------------------
  - name: base_aact_design_group
    description: "Base cleaned version of AACT table design_groups."
    columns:
      - name: id_design_groups
        description: "Design group identifier."
        tests:
          - not_null
          - unique

      - name: nct_id
        description: "Normalized NCT identifier (uppercase, alphanumeric)."
        tests:
          - not_null
          - unique


      - name: group_type_id
        description: "Hashed identifier of group_type."
        tests:
          - not_null

      - name: group_type
        description: "Group type name."

      - name: title
        description: "Group title."

      - name: description
        description: "Group description."


  # -------------------------------------------------------------------------
  # stg_aact_design_group
  # -------------------------------------------------------------------------
  - name: design_group
    description: "Staging table for AACT design_groups."
    columns:
      - name: id_design_groups
        description: "Design group ID."
        tests:
          - not_null
          - unique

      - name: nct_id
        description: "Cleaned clinical trial ID."
        tests:
          - not_null


      - name: group_type_id
        description: "Hashed group type ID."

      - name: title
        description: "Group title."

      - name: description
        description: "Group description."


  # -------------------------------------------------------------------------
  # stg_aact_group_type
  # -------------------------------------------------------------------------
  - name: group_type
    description: "Distinct group types with hashed keys."
    columns:
      - name: group_type_id
        description: "Hashed group type ID."
        tests:
          - not_null
          - unique

      - name: group_type
        description: "Group type."
        tests:
          - not_null
          - accepted_values:
              arguments:
                values: ["no_group_type"]


  # -------------------------------------------------------------------------
  # base_aact_design_group_interventions
  # -------------------------------------------------------------------------
  - name: design_group_interventions
    description: "Base cleaned version of design_group_interventions."
    columns:
      - name: id_design_group_interventions
        description: "Unique identifier for this row."
        tests:
          - not_null
          - unique

      - name: nct_id
        description: "Normalized NCT identifier."
        tests:
          - not_null

      - name: design_group_id
        description: "FK to design_groups.id_design_groups."
        tests:
          - not_null
          - relationships:
              arguments:
                to: ref('base_aact_design_group')
                field: id_design_groups
      - name: intervention_id
        description: "FK to interventions table (when available)."
        tests:
          - not_null


  # -------------------------------------------------------------------------
  # base_aact_condition
  # -------------------------------------------------------------------------
  - name: conditions
    description: "AACT condition table."
    columns:
      - name: id_condition
        description: "Unique condition identifier."
        tests:
          - not_null
          - unique

      - name: nct_id
        description: "Normalized clinical trial identifier."
        tests:
          - not_null

          - relationships:
              config:
                severity: warn
              arguments:
                to: ref('base_aact_design_group')
                field: nct_id
      - name: condition_name
        description: "Lowercased condition name."


  # =========================================================================
  # NEW TABLES FOR drop_withdrawals
  # =========================================================================

  # -------------------------------------------------------------------------
  # base_aact_drop_withdrawals
  # -------------------------------------------------------------------------
  - name: base_aact_drop_withdrawals
    description: "Base cleaned version of AACT drop_withdrawals table."
    columns:
      - name: id_drop_withdrawals
        description: "Unique identifier for drop withdrawals."
        tests:
          - not_null
          - unique

      - name: nct_id
        description: "Normalized NCT identifier."
        tests:
          - not_null


      - name: result_group_id
        description: "Hashed ID of result group."
        tests:
          - relationships:
              arguments:
                to: ref('result_group')
                field: result_group_id
      - name: result_group_name
        description: "Name of the result group."

      - name: ctgov_group_code_id
        description: "Hashed code for result group classification."
        tests:
          - not_null
          - relationships:
              arguments:
                to: ref('ctgov_group_code')
                field: ctgov_group_code_id
      - name: ctgov_group_code
        description: "Raw CTGOV group code."

      - name: period_id
        description: "Hashed identifier of the reporting period."
        tests:
          - not_null
          - relationships:
              arguments:
                to: ref('period')
                field: period_id
      - name: period
        description: "Period label."

      - name: reason_id
        description: "Hashed identifier for the withdrawal reason."
        tests:
          - not_null
          - relationships:
              arguments:
                to: ref('reason')
                field: reason_id
      - name: reason
        description: "Withdrawal reason."

      - name: count
        description: "Number of withdrawals."
        tests:
          - not_null


  # -------------------------------------------------------------------------
  # ctgov_group_code
  # -------------------------------------------------------------------------
  - name: ctgov_group_code
    description: "Table containing distinct CTGOV group codes."
    columns:
      - name: ctgov_group_code_id
        description: "Hashed identifier for CTGOV group code."
        tests:
          - not_null
          - unique

      - name: ctgov_group_code
        description: "Raw CTGOV group code."
        tests:
          - not_null


  # -------------------------------------------------------------------------
  # drop_withdrawals (staging)
  # -------------------------------------------------------------------------
  - name: drop_withdrawals
    description: "Staging version of drop withdrawals referencing normalized entities."
    columns:
      - name: id_drop_withdrawals
        description: "Drop withdrawals ID."
        tests:
          - not_null
          - unique

      - name: nct_id
        description: "Normalized clinical trial ID."
        tests:
          - not_null

      - name: result_group_id
        description: "FK to result_group."
        tests:
          - relationships:
              arguments:
                to: ref('result_group')
                field: result_group_id
      - name: ctgov_group_code_id
        description: "FK to ctgov_group_code."
        tests:
          - relationships:
              arguments:
                to: ref('ctgov_group_code')
                field: ctgov_group_code_id
      - name: period_id
        description: "FK to period."
        tests:
          - relationships:
              arguments:
                to: ref('period')
                field: period_id
      - name: reason_id
        description: "FK to reason."
        tests:
          - relationships:
              arguments:
                to: ref('reason')
                field: reason_id
      - name: count
        description: "Number of withdrawals."


  # -------------------------------------------------------------------------
  # period
  # -------------------------------------------------------------------------
  - name: period
    description: "Distinct periods for drop withdrawals."
    columns:
      - name: period_id
        description: "Hashed identifier for period."
        tests:
          - not_null
          - unique

      - name: period
        description: "Period label."
        tests:
          - not_null


  # -------------------------------------------------------------------------
  # reason
  # -------------------------------------------------------------------------
  - name: reason
    description: "Distinct reasons for drop withdrawals."
    columns:
      - name: reason_id
        description: "Hashed identifier for reason."
        tests:
          - not_null
          - unique

      - name: reason
        description: "Reason label."
        tests:
          - not_null


  # -------------------------------------------------------------------------
  # result_group
  # -------------------------------------------------------------------------
  - name: result_group
    description: "Distinct result groups used in drop withdrawals."
    columns:
      - name: result_group_id
        description: "Hashed identifier for result group."
        tests:
          - not_null
          - unique

      - name: result_group_name
        description: "Name of the result group."
        tests:
          - not_null